<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/tos/styles.css">
    <title>Admin - The Organic Studio</title>
</head>

<body>
    <main>
        <div class="container">
            <a href="/tos/" style="text-decoration: none; font-size:16px; color:#999">Go Back</a>
            <h1>Add New Product</h1>
            <div class="form">
                <input type="text" placeholder="Title" id="tit">
                <input type="text" placeholder="Label" id="label" style="margin-bottom: 0;"><br>
                <label for="label" style="color: #666;">Leave empty to hide label</label><br>
               
                <textarea id="adv" cols="30" rows="10" placeholder="Advantages" style="margin-top: 20px;"></textarea>
                <input type="text" placeholder="Categories" id="categories" style="margin-bottom: 0;"><br>
                <label for="categories" style="color: #666;">Seperated By coma ( , )</label><br>
                <input type="text" placeholder="Keywords" id="keywords" style="margin-top: 20px; margin-bottom:0;"><br>
                <label for="keyword" style="color: #666;">Adding keywords wll make easy to search <br>(Seperated by
                    comas)</label><br>
                <textarea id="des" cols="30" rows="10" placeholder="Description" style="margin-top: 20px;"></textarea>
                <h6 style="font-size: 20px; font-weight:400; margin:0; margin-top:20px;">Add Varients</h6>
                <div class="variants-div">
                    <label for="qnty" id="qnty-label">Quantity</label>
                    <input type="text" id="qnty" placeholder="Eg: 500g">
                    <label for="qnty-price" id="qnty-price-label">Price</label>
                    <input type="number" id="qnty-price" placeholder="Eg: 30">
                    <label for="qnty-price" id="qnty-price-label">Offer Price</label>
                    <input type="number" id="off-price" placeholder="Eg: 20" style="margin-bottom: 0;"><br>
                    <label for="off-price" style="color: #666;margin-top:0;">Leave Offer Price Box <br>Empty If Its Not A Product Under Offer</label><br>
                </div>
                <button class="add-btn" onclick="addVarient()">ADD</button>
                <h6 style="font-size: 20px; font-weight:400; margin:0; margin-top:20px; margin-bottom:10px;">Varient
                    Lists</h6>
                <div id="varient-lists" style="display: flex; align-items:center;width:auto; flex-wrap:wrap; gap:10px">
                    <i style="color: #888;" id="suggest">There Is No Varients</i>
                </div>
                <div class="input-container">
                    <label class="custum-file-upload" for="file" id="dropArea" ondrop="handleDrop(event)"
                        ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <div id="image-container" style="overflow:hidden; width: 100%; height:100%;">

                        </div>
                        <div class="icon" id="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="" viewBox="0 0 24 24">
                                <g stroke-width="0" id="SVGRepo_bgCarrier"></g>
                                <g stroke-linejoin="round" stroke-linecap="round" id="SVGRepo_tracerCarrier"></g>
                                <g id="SVGRepo_iconCarrier">
                                    <path fill=""
                                        d="M10 1C9.73478 1 9.48043 1.10536 9.29289 1.29289L3.29289 7.29289C3.10536 7.48043 3 7.73478 3 8V20C3 21.6569 4.34315 23 6 23H7C7.55228 23 8 22.5523 8 22C8 21.4477 7.55228 21 7 21H6C5.44772 21 5 20.5523 5 20V9H10C10.5523 9 11 8.55228 11 8V3H18C18.5523 3 19 3.44772 19 4V9C19 9.55228 19.4477 10 20 10C20.5523 10 21 9.55228 21 9V4C21 2.34315 19.6569 1 18 1H10ZM9 7H6.41421L9 4.41421V7ZM14 15.5C14 14.1193 15.1193 13 16.5 13C17.8807 13 19 14.1193 19 15.5V16V17H20C21.1046 17 22 17.8954 22 19C22 20.1046 21.1046 21 20 21H13C11.8954 21 11 20.1046 11 19C11 17.8954 11.8954 17 13 17H14V16V15.5ZM16.5 11C14.142 11 12.2076 12.8136 12.0156 15.122C10.2825 15.5606 9 17.1305 9 19C9 21.2091 10.7909 23 13 23H20C22.2091 23 24 21.2091 24 19C24 17.1305 22.7175 15.5606 20.9844 15.122C20.7924 12.8136 18.858 11 16.5 11Z"
                                        clip-rule="evenodd" fill-rule="evenodd"></path>
                                </g>
                            </svg>
                        </div>
                        <div class="text">
                            <span id="text-holder" style="text-align: center;">Click To Upload Image <br> / Drag & Drop</span>
                        </div>
                        <input type="file" id="file" oninput="selectImage()" accept="image/*" multiple>
                    </label>
                </div>
                <button onclick="release()">CONFIRM & RELEASE</button>


            </div>
        </div>
        <div class="dialog">
            <div class="card">
                <div class="card__title">Updating Contents <br><span style="font-size:20px; margin-left: 10px;"
                        id="totalfiles"></span>
                    <div class="card__subtitle">Please wait while we updating the database , Do not close the window
                    </div>
                    <div class="card__indicator"><span class="card__indicator-percentage" id="p-text">0%</span></div>
                    <div class="card__progress"><progress value="0" max="100" id="progress"></progress></div>
                </div>
            </div>
        </div>
        <div class="success-dialog">
            <div class="notifications-container">
                <div class="success">
                    <div class="flex">
                        <div class="success-prompt-wrap">
                            <p class="success-prompt-heading">Product Successfully Added</p>
                            <div class="success-prompt-prompt">
                                <p>
                                    New Product Added To Databse , You Can Add A New Product By Refreshing The Website
                                </p>
                            </div>
                            <div class="success-button-container">
                                <button class="success-button-main" type="button"
                                    onclick="window.location.href='/tos/'">
                                    Exit
                                </button>
                                <button class="success-button-secondary" type="button"
                                    onclick="window.location.href='/tos/products/add'">
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>
</body>
<style>
    button {
        border: none;
        display: flex;
        justify-content: center;
        padding: 20px 15px;
        background-color: teal;
        color: #ffffff;
        font-size: 0.75rem;
        line-height: 1rem;
        font-weight: 700;
        text-align: center;
        text-transform: uppercase;
        vertical-align: middle;
        align-items: center;
        border-radius: 0.5rem;
        user-select: none;
        gap: 0.75rem;
        box-shadow: 0 4px 6px -1px #488aec31, 0 2px 4px -1px #488aec17;
        transition: all .6s ease;
        width: 70%;
    }

    .child-qnty {
        border: 1px dashed green;
        padding: 6px 10px;
        border-radius: 60px;
        background: rgba(0, 128, 128, 0.171);
        flex: 0 0 auto;
    }

    .variants-div {
        display: flex;
        width: 100%;
        justify-content: flex-start;
        align-items: center;
    }

    @media screen and (max-width:800px) {
        .variants-div {
            align-items: flex-start;
            flex-direction: column;
        }

        .variants-div label {
            margin-top: 10px;
        }

        .variants-div input {
            margin-left: 0;
        }
    }

    .variants-div input {
        width: 17%;
        margin-left: 10px;
        margin-right: 20px;

    }

    .variants-div label {
        color: #666;
    }

    .add-btn {
        padding: 10px 6px;
        margin-bottom: 20px;
    }

    button:hover {
        box-shadow: 0 10px 15px -3px #488aec4f, 0 4px 6px -2px #488aec17;
    }

    button:focus,
    button:active {
        opacity: .85;
        box-shadow: none;
    }

    textarea {
        resize: none;
    }

    #dropArea.active {
        background: #999;
    }
</style>
<script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.8.0/firebase-storage.js"></script>

<script>
    var file;
    var imageURL = [];
    var imageName = [];
    var imgLayout = document.getElementById('image-container');
    var varientArray = [];

    function addVarient() {
        var qnty = document.getElementById('qnty');
        var qntyPrice = document.getElementById('qnty-price');
        var offPrice = document.getElementById('off-price');
        if (qnty.value !== "" && qntyPrice.value !== "") {
            qntyPrice.style.border = '2px solid #999999';
            document.getElementById('qnty-price-label').style.color = '#666666';
            qntyPrice.style.border = '2px solid #999999';
            document.getElementById('qnty-price-label').style.color = '#666666';
            qnty.style.border = '2px solid #999999';
            document.getElementById('qnty-label').style.color = '#666666';
            var varientList = document.getElementById('varient-lists');
            var childQnty = document.createElement('div');
            childQnty.className = 'child-qnty';
            var labelQ = document.createElement('label');
            labelQ.setAttribute('for', 'qnty');
            labelQ.style.color = 'blueviolet';
            var span1 = document.createElement('span');
            span1.style.color = 'rgb(25, 197, 25)';
            span1.textContent = qnty.value;

            var span2 = document.createElement('span');
            span2.style.color = 'lightcoral';
            span2.textContent = qntyPrice.value;
            if(offPrice.value == ""){
                labelQ.innerHTML = span1.outerHTML + " : ₹" + span2.outerHTML;
            }else{
                labelQ.innerHTML = span1.outerHTML + " : ₹" + span2.outerHTML+" => ₹"+offPrice.value;
            }
            childQnty.appendChild(labelQ);
            document.getElementById('suggest').style.display = 'none';
            varientList.appendChild(childQnty);

            const newJsonObject1 = {
                "label": qnty.value,
                "price": qntyPrice.value,
                "offerprice": offPrice.value
            };
            varientArray.push(newJsonObject1);

            qnty.value = '';
            qntyPrice.value = '';
            offPrice.value = '';
        } else {
            if (qnty.value == "") {
                qnty.style.border = '2px solid #D32F2F';
                document.getElementById('qnty-label').style.color = '#D32F2F';

            } else {
                qntyPrice.style.border = '2px solid #D32F2F';
                document.getElementById('qnty-price-label').style.color = '#D32F2F';
            }
        }

    }

    function handleDrop(event) {
        event.preventDefault();
        const dropArea = document.getElementById('dropArea');

        // Check if the dropped items contain files
        if (event.dataTransfer.items) {
            // Use DataTransferItemList interface to access the file(s)
            for (const item of event.dataTransfer.items) {
                // If dropped item is a file, get the file
                if (item.type.startsWith('image/')) {
                    document.getElementById('icon').style.display = 'none';
                    const file = item.getAsFile();
                    imageURL.push(file);
                    imageName.push(file.name);
                    var imgHolder = document.createElement('img');
                    imgHolder.src = URL.createObjectURL(imageURL[imageURL.length - 1]);
                    imgHolder.style.objectFit = 'cover';
                    imgHolder.style.width = '80px';
                    imgHolder.style.height = '80px';
                    imgLayout.appendChild(imgHolder);
                }
            }
        } else {
            // Use DataTransfer interface to access the file(s)
            for (const file of event.dataTransfer.files) {
                if (item.type.startsWith('image/')) {
                    document.getElementById('icon').style.display = 'none';
                    const file = item.getAsFile();
                    imageURL.push(file);
                    imageName.push(file.name);
                    var imgHolder = document.createElement('img');
                    imgHolder.src = URL.createObjectURL(imageURL[imageURL.length - 1]);
                    imgHolder.style.objectFit = 'cover';
                    imgHolder.style.width = '80px';
                    imgHolder.style.height = '80px';
                    imgLayout.appendChild(imgHolder);
                }
            }
        }

        // Reset the appearance of the drop area
        dropArea.classList.remove('active');
    }

    // Function to handle drag over
    function handleDragOver(event) {
        event.preventDefault();
        const dropArea = document.getElementById('dropArea');

        // Highlight the drop area when a file is dragged over it
        dropArea.classList.add('active');
    }

    // Function to handle drag leave
    function handleDragLeave(event) {
        const dropArea = document.getElementById('dropArea');

        // Reset the appearance of the drop area when the file leaves
        dropArea.classList.remove('active');
    }


    function selectImage() {
        document.getElementById('icon').style.display = 'none';
        file = document.getElementById('file').files[0];
        flength = document.getElementById('file').files.length;

        imageURL = [];
        imageName = [];
        imgLayout.innerHTML = '';
        var i;
        for (i = 0; i < flength; i++) {
            var imgHolder = document.createElement('img');
            imageURL.push(URL.createObjectURL(document.getElementById('file').files[i]));
            imageName.push(document.getElementById('file').files[i].name);
            imgHolder.src = imageURL[i];
            imgHolder.style.objectFit = 'cover';
            imgHolder.style.width = '80px';
            imgHolder.style.height = '80px';
            imgLayout.appendChild(imgHolder);
        }
    }

    // Initialize Firebase with your configuration
    const firebaseConfig = {
        apiKey: "AIzaSyCV1Z8-EZWdUwPnsAiPrRn6hScbt9_AnHs",
        authDomain: "kaisonline.firebaseapp.com",
        projectId: "kaisonline",
        storageBucket: "kaisonline.appspot.com",
        messagingSenderId: "1038384566126",
        appId: "1:1038384566126:web:0a2dab22a90c750066bb7f",
        measurementId: "G-336STKC5HQ"
    };

    firebase.initializeApp(firebaseConfig);

    // Get a reference to the Firebase Storage service
    const storage = firebase.storage();

    // File input and progress bar

    function release() {
        var docid = "null";
        document.querySelector('.dialog').style.display = 'flex';
        var dwnldurls = [];

        // Create a Firestore reference
        const fires = firebase.firestore();

        // Create an array to store upload promises
        const uploadPromises = [];

        // Iterate over the files
        imageURL.forEach((file, j) => {
            // Create a storage reference with a unique name
            const storageRef = storage.ref('product-images/' + imageName[j]);

            // Upload the file
            console.log(file , imageName[j])
            const uploadTask = storageRef.put(file);

            // Create a promise for each upload task
            const uploadPromise = new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Update the progress bar during the upload
                        var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        progress = isNaN(progress) ? 0 : Math.min(Math.max(progress, 0), 100); // Ensure progress is a valid percentage
                        progress = (Math.floor(progress * 10) / 10).toFixed(1);
                        document.getElementById('p-text').textContent = progress + "%";
                        document.getElementById('progress').value = progress;
                    },
                    (error) => {
                        console.error('Error uploading file: ', error);
                        reject(error);
                    },
                    () => {
                        // When the upload is complete
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            console.log('File download URL:', downloadURL);
                            dwnldurls.push(downloadURL);
                            resolve();
                        });
                    }
                );
            });

            uploadPromises.push(uploadPromise);
        });

        // Wait for all upload promises to resolve
        Promise.all(uploadPromises)
            .then(() => {
                
                keywordB = document.getElementById('keywords').value.toLowerCase().trim();
                if(keywordB==""){
                    keywordB = document.getElementById('tit').value+","+document.getElementById('label').value+","+document.getElementById('des').value+","+document.getElementById('categories').value;
                }else{
                    keywordB = keywordB+","+document.getElementById('tit').value+","+document.getElementById('label').value+","+document.getElementById('des').value+","+document.getElementById('categories').value;
                }
                keywordArray = keywordB.split(',').map(item => item.toLowerCase().trim());
                // Data to add to the document
                const data = {
                    title: document.getElementById('tit').value,
                    label: document.getElementById('label').value,
                    advantages: document.getElementById('adv').value,
                    categories: document.getElementById('categories').value.toLowerCase(),
                    keywords: keywordArray,
                    description: document.getElementById('des').value,
                    varients: varientArray,
                    price: (varientArray[0].offerprice=='0')?varientArray[0].price:varientArray[0].offerprice,
                    images: dwnldurls,
                };

                // Check if it's the first time creating the document
                if (docid == "null") {
                    fires.collection("site/tos/products")
                        .add(data)
                        .then((docRef) => {
                            console.log("Data written with ID: ", docRef.id);
                            docid = docRef.id;
                            document.querySelector('.success-dialog').style.display = 'flex';
                        })
                        .catch((error) => {
                            console.error("Error adding document: ", error);
                        });
                } else {
                    // If it's not the first time, update the existing document
                    fires.collection("site/tos/products").doc(docid)
                        .update(data)
                        .then((docRef) => {
                            console.log("Data updated with ID: ", docRef.id);
                            document.querySelector('.success-dialog').style.display = 'flex';
                        })
                        .catch((error) => {
                            console.error("Error updating document: ", error);
                        });
                }
            })
            .catch((error) => {
                console.error("Error uploading files: ", error);
            });
    }

</script>

</html>

